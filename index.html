<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Analyse des Risques Professionnels – Interface Expert Multisectorielle</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #0f4c75;
      --primary-light: #3273a8;
      --secondary: #2e7d32;
      --accent: #00c6ff;
      --accent-glow: rgba(0, 198, 255, 0.4);
      --dark: #0a1a2a;
      --darker: #06121e;
      --light: #f8fafc;
      --gray: #64748b;
      --card-bg: rgba(255, 255, 255, 0.08);
      --card-border: rgba(255, 255, 255, 0.1);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      --inner-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1);
      
      /* Couleurs par secteur */
      --sector-btp: #0f4c75;
      --sector-industrie: #7b1fa2;
      --sector-tertiaire: #d84315;
      --sector-agricole: #388e3c;
      --sector-sante: #00838f;
      
      /* Couleurs risques */
      --risk-physical: #ff6b6b;
      --risk-chemical: #4ecdc4;
      --risk-ergonomic: #ffe66d;
      --risk-environmental: #45b7d1;
      --risk-third-party: #96ceb4;
      --risk-prevention: #6a0572;
      --risk-description: #9c27b0;
      --risk-organization: #ff9800;
      --prevention-identification: #e91e63;
      --prevention-materials: #2196f3;
      --prevention-instructions: #4caf50;
      --prevention-rescue: #ff5722;
      --prevention-coordination: #9c27b0;
      --prevention-responsibilities: #607d8b;
      --prevention-asbestos: #795548;
      --prevention-description: #2196f3;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 50%, #0f2a42 100%);
      margin: 0;
      padding: 20px;
      color: var(--light);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 20% 80%, rgba(15, 76, 117, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(46, 125, 50, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(0, 198, 255, 0.1) 0%, transparent 50%);
      z-index: -1;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: var(--card-bg);
      backdrop-filter: blur(10px);
      padding: 30px;
      border-radius: 20px;
      box-shadow: var(--shadow);
      border: 1px solid var(--card-border);
      position: relative;
      overflow: hidden;
      animation: containerAppear 0.8s ease-out;
    }

    @keyframes containerAppear {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--primary-light), var(--secondary));
      animation: borderGlow 3s infinite alternate;
    }

    @keyframes borderGlow {
      0% {
        box-shadow: 0 0 10px var(--accent-glow);
      }
      100% {
        box-shadow: 0 0 20px var(--accent-glow), 0 0 30px rgba(15, 76, 117, 0.4);
      }
    }

    .header-section {
      text-align: center;
      margin-bottom: 30px;
      padding: 25px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      border: 1px solid var(--card-border);
      position: relative;
      backdrop-filter: blur(10px);
    }

    .settings-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--card-border);
      color: var(--light);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 18px;
    }

    .settings-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }

    h1 {
      color: var(--light);
      margin-bottom: 12px;
      font-weight: 700;
      font-size: 2.5rem;
      background: linear-gradient(to right, var(--accent), var(--primary-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: titleGlow 3s infinite alternate;
    }

    @keyframes titleGlow {
      0% {
        text-shadow: 0 0 5px rgba(0, 198, 255, 0.3);
      }
      100% {
        text-shadow: 0 0 15px rgba(0, 198, 255, 0.6);
      }
    }

    p.subtitle {
      color: var(--gray);
      margin-bottom: 25px;
      font-size: 16px;
      animation: fadeIn 1s ease-out 0.2s both;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .configuration-panel {
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
      border-radius: 16px;
      border: 1px solid var(--card-border);
      margin-bottom: 25px;
      backdrop-filter: blur(10px);
    }

    .config-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--light);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sector-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 15px;
    }

    .sector-btn {
      flex: 1;
      min-width: 120px;
      padding: 12px 15px;
      border: 2px solid var(--card-border);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--light);
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }

    .sector-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s;
    }

    .sector-btn:hover::before {
      left: 100%;
    }

    .sector-btn.active {
      background: var(--sector-color, var(--primary));
      border-color: var(--sector-color, var(--accent));
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      transform: translateY(-2px);
    }

    .sector-btn i {
      margin-right: 8px;
    }

    .reglementation-info {
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid rgba(255, 193, 7, 0.3);
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      display: none;
    }

    .reglementation-info.active {
      display: block;
      animation: fadeIn 0.5s ease-out;
    }

    .reg-title {
      font-weight: 600;
      color: #ffd54f;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .reg-content {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.9);
      line-height: 1.5;
    }

    .function-selector {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 16px;
      border: 1px solid var(--card-border);
      backdrop-filter: blur(10px);
    }

    .function-btn {
      flex: 1;
      padding: 18px 20px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.1);
      color: var(--light);
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .function-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .function-btn:hover::before {
      left: 100%;
    }

    .function-btn.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      border-color: var(--accent);
      box-shadow: 0 4px 15px rgba(15, 76, 117, 0.4);
    }

    .function-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    .input-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    @media (max-width: 768px) {
      .input-grid {
        grid-template-columns: 1fr;
      }
      
      .function-selector {
        flex-direction: column;
      }
      
      .sector-selector {
        flex-direction: column;
      }
    }

    .form-group {
      animation: slideInUp 0.6s ease-out both;
      position: relative;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--light);
      font-size: 15px;
    }

    .label-icon {
      margin-right: 8px;
      color: var(--accent);
    }

    input, textarea, select {
      width: 100%;
      padding: 16px 18px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--card-border);
      border-radius: 12px;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 15px;
      color: var(--light);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-2px);
    }

    input::placeholder, textarea::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 25px;
      animation: fadeIn 0.8s ease-out 0.4s both;
    }

    .btn {
      padding: 18px 24px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      flex: 1;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-analyze {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(15, 76, 117, 0.4);
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .btn:active {
      transform: translateY(-1px);
    }

    .btn:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn:disabled::before {
      display: none;
    }

    .export-options {
      margin-top: 15px;
      display: none;
      gap: 10px;
      justify-content: center;
      animation: fadeIn 0.5s ease-out;
    }

    .export-btn {
      padding: 14px 24px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      transition: all 0.3s ease;
      border: 1px solid var(--card-border);
      backdrop-filter: blur(10px);
    }

    .export-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    #preview {
      margin-top: 30px;
      display: none;
      animation: previewAppear 0.5s ease-out;
    }

    @keyframes previewAppear {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .preview-header {
      text-align: center;
      margin-bottom: 25px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      border: 1px solid var(--card-border);
      backdrop-filter: blur(10px);
    }

    .preview-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--light);
      margin-bottom: 8px;
      background: linear-gradient(to right, var(--accent), var(--primary-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .preview-subtitle {
      color: var(--gray);
      font-size: 14px;
    }

    .risk-section {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid var(--card-border);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .risk-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 6px;
      height: 100%;
      background: var(--section-color, var(--accent));
    }

    .risk-section:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      background: rgba(255, 255, 255, 0.07);
    }

    .risk-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--card-border);
    }

    .risk-icon {
      width: 55px;
      height: 55px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 18px;
      background: var(--section-color, var(--accent));
      color: white;
      font-size: 22px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }

    .risk-section:hover .risk-icon {
      transform: scale(1.05);
    }

    .risk-title {
      font-size: 22px;
      font-weight: 700;
      color: var(--section-color, var(--accent));
      margin: 0;
    }

    .risk-subtitle {
      font-size: 14px;
      color: var(--gray);
      margin-top: 6px;
    }

    .risk-content {
      padding-left: 73px;
    }

    .sub-risk {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      border-left: 4px solid var(--sub-risk-color, var(--accent));
      transition: all 0.2s ease;
      backdrop-filter: blur(5px);
    }

    .sub-risk:hover {
      background: rgba(255, 255, 255, 0.06);
      transform: translateX(5px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .sub-risk-title {
      font-weight: 600;
      color: var(--light);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      font-size: 17px;
    }

    .sub-risk-title i {
      margin-right: 10px;
      color: var(--sub-risk-color, var(--accent));
      font-size: 14px;
    }

    .sub-risk-items {
      padding-left: 24px;
    }

    .sub-risk-item {
      margin-bottom: 8px;
      position: relative;
      padding-left: 20px;
      line-height: 1.6;
      color: rgba(255, 255, 255, 0.9);
    }

    .sub-risk-item::before {
      content: '•';
      position: absolute;
      left: 0;
      color: var(--sub-risk-color, var(--accent));
      font-weight: bold;
      font-size: 18px;
    }

    .status {
      margin-top: 20px;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      display: none;
      animation: statusPulse 2s infinite;
      backdrop-filter: blur(10px);
      border: 1px solid;
    }

    @keyframes statusPulse {
      0% {
        box-shadow: 0 0 0 0 rgba(46, 125, 50, 0.4);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(46, 125, 50, 0);
      }
    }

    .success {
      background: rgba(46, 125, 50, 0.15);
      color: #a5d6a7;
      border-color: rgba(46, 125, 50, 0.3);
    }

    .error {
      background: rgba(197, 48, 48, 0.15);
      color: #ef9a9a;
      border-color: rgba(197, 48, 48, 0.3);
    }

    .floating-elements {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: -1;
    }

    .floating-element {
      position: absolute;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 50%;
      animation: float 15s infinite linear;
    }

    @keyframes float {
      0% {
        transform: translateY(0) rotate(0deg);
      }
      100% {
        transform: translateY(-1000px) rotate(720deg);
      }
    }

    .pulse-dot {
      position: absolute;
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(0, 198, 255, 0.7);
      }
      70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(0, 198, 255, 0);
      }
      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(0, 198, 255, 0);
      }
    }

    .tech-grid {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        linear-gradient(rgba(10, 26, 42, 0.8) 1px, transparent 1px),
        linear-gradient(90deg, rgba(10, 26, 42, 0.8) 1px, transparent 1px);
      background-size: 40px 40px;
      z-index: -2;
      opacity: 0.3;
    }

    /* Styles pour le popup de paramètres */
    .settings-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease-out;
    }

    .settings-popup {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 30px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
      animation: popupAppear 0.4s ease-out;
    }

    @keyframes popupAppear {
      0% {
        opacity: 0;
        transform: scale(0.8) translateY(-20px);
      }
      100% {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--card-border);
    }

    .settings-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--light);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .close-btn {
      background: none;
      border: none;
      color: var(--gray);
      font-size: 24px;
      cursor: pointer;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--light);
    }

    /* Styles pour la section API Key */
    .api-key-section {
      margin-bottom: 25px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      border: 1px solid var(--card-border);
    }

    .api-status {
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
      backdrop-filter: blur(10px);
      margin-top: 10px;
    }

    .api-status.success {
      background: rgba(46, 125, 50, 0.15);
      color: #a5d6a7;
      border: 1px solid rgba(46, 125, 50, 0.3);
    }

    .api-status.error {
      background: rgba(197, 48, 48, 0.15);
      color: #ef9a9a;
      border: 1px solid rgba(197, 48, 48, 0.3);
    }

    .api-status.testing {
      background: rgba(255, 193, 7, 0.15);
      color: #ffd54f;
      border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .toggle-password {
      background: none;
      border: none;
      color: var(--gray);
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: all 0.3s ease;
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
    }

    .toggle-password:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--light);
    }

    .char-counter {
      text-align: right;
      font-size: 12px;
      color: var(--gray);
      margin-top: 5px;
    }

    .char-counter.warning {
      color: #ff6b6b;
    }

    /* Styles pour l'ajout de modèles */
    .add-model-section {
      margin-bottom: 25px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      border: 1px solid var(--card-border);
    }

    .add-model-btn {
      background: rgba(46, 125, 50, 0.2);
      color: #a5d6a7;
      border: 1px solid rgba(46, 125, 50, 0.3);
      width: 100%;
      margin-top: 10px;
    }

    .add-model-btn:hover {
      background: rgba(46, 125, 50, 0.3);
    }

    .edit-model-btn {
      background: rgba(255, 193, 7, 0.2);
      color: #ffd54f;
      border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .edit-model-btn:hover {
      background: rgba(255, 193, 7, 0.3);
    }

    .model-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 25px;
      max-height: 300px;
      overflow-y: auto;
      padding-right: 5px;
    }

    .model-options::-webkit-scrollbar {
      width: 6px;
    }

    .model-options::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
    }

    .model-options::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 3px;
    }

    .model-option {
      display: flex;
      align-items: center;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid var(--card-border);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .model-option:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--accent);
    }

    .model-option.selected {
      background: rgba(0, 198, 255, 0.1);
      border-color: var(--accent);
    }

    .model-radio {
      margin-right: 12px;
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    .model-info {
      flex: 1;
    }

    .model-name {
      font-weight: 600;
      color: var(--light);
      margin-bottom: 4px;
    }

    .model-details {
      font-size: 12px;
      color: var(--gray);
    }

    .model-free-badge {
      background: var(--secondary);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .model-preview-badge {
      background: var(--primary);
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .model-custom-badge {
      background: #9c27b0;
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }

    .model-actions {
      display: flex;
      gap: 5px;
      margin-left: 8px;
    }

    .edit-model-btn-small {
      background: none;
      border: none;
      color: var(--gray);
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    .edit-model-btn-small:hover {
      background: rgba(255, 193, 7, 0.2);
      color: #ffd54f;
    }

    .delete-model-btn {
      background: none;
      border: none;
      color: var(--gray);
      cursor: pointer;
      padding: 5px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }

    .delete-model-btn:hover {
      background: rgba(197, 48, 48, 0.2);
      color: #ef9a9a;
    }

    .current-model-display {
      background: rgba(255, 255, 255, 0.05);
      padding: 12px 16px;
      border-radius: 10px;
      margin-top: 20px;
      border-left: 4px solid var(--accent);
    }

    .current-model-label {
      font-size: 12px;
      color: var(--gray);
      margin-bottom: 4px;
    }

    .current-model-value {
      font-weight: 600;
      color: var(--light);
    }

    /* Styles pour le popup d'édition */
    .edit-model-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      animation: fadeIn 0.3s ease-out;
    }

    .edit-model-popup {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--card-border);
      border-radius: 20px;
      padding: 30px;
      width: 90%;
      max-width: 500px;
      box-shadow: var(--shadow);
      animation: popupAppear 0.4s ease-out;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .risk-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .risk-icon {
        margin-bottom: 10px;
        margin-right: 0;
      }
      
      .risk-content {
        padding-left: 0;
      }
      
      .settings-popup {
        margin: 20px;
        padding: 20px;
      }
      
      .model-options {
        max-height: 250px;
      }
      
      .api-key-section, .add-model-section {
        padding: 15px;
      }
      
      .configuration-panel {
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="tech-grid"></div>
  <div class="floating-elements" id="floatingElements"></div>
  
  <!-- Popup de paramètres -->
  <div class="settings-overlay" id="settingsOverlay">
    <div class="settings-popup">
      <div class="settings-header">
        <div class="settings-title">
          <i class="fas fa-cog"></i>
          Paramètres
        </div>
        <button class="close-btn" onclick="closeSettings()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <!-- Section API Key -->
      <div class="api-key-section">
        <div class="settings-title" style="font-size: 1.2rem; margin-bottom: 15px;">
          <i class="fas fa-key"></i>
          Configuration API
        </div>
        
        <div class="form-group">
          <label for="apiKeyInput">
            <i class="fas fa-key label-icon"></i>
            Clé API OpenRouter
          </label>
          <div style="position: relative;">
            <input 
              type="password" 
              id="apiKeyInput" 
              placeholder="Saisissez votre clé API OpenRouter"
              style="padding-right: 40px;"
            />
            <button 
              type="button" 
              class="toggle-password" 
              onclick="toggleApiKeyVisibility()"
            >
              <i class="fas fa-eye"></i>
            </button>
          </div>
          <div class="char-counter" id="apiKeyCounter">0 caractères</div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <button class="export-btn" onclick="saveApiKey()" style="flex: 1;">
            <i class="fas fa-save"></i> Sauvegarder
          </button>
          <button class="export-btn" onclick="testApiKey()" style="flex: 1;">
            <i class="fas fa-vial"></i> Tester
          </button>
          <button class="export-btn" onclick="clearApiKey()" style="flex: 1; background: rgba(197, 48, 48, 0.2);">
            <i class="fas fa-trash"></i> Effacer
          </button>
        </div>
        
        <div class="api-status" id="apiStatus"></div>
      </div>
      
      <hr style="border: none; height: 1px; background: var(--card-border); margin: 25px 0;">
      
      <!-- Section Ajout de Modèles -->
      <div class="add-model-section">
        <div class="settings-title" style="font-size: 1.2rem; margin-bottom: 15px;">
          <i class="fas fa-plus-circle"></i>
          Ajouter un modèle personnalisé
        </div>
        
        <div class="form-group">
          <label for="modelIdInput">ID du modèle OpenRouter</label>
          <input type="text" id="modelIdInput" placeholder="ex: anthropic/claude-3.5-sonnet" />
        </div>
        
        <button class="export-btn add-model-btn" onclick="addCustomModel()">
          <i class="fas fa-plus"></i> Ajouter le modèle
        </button>
      </div>
      
      <hr style="border: none; height: 1px; background: var(--card-border); margin: 25px 0;">
      
      <!-- Section Modèles -->
      <div class="settings-title" style="font-size: 1.2rem; margin-bottom: 15px;">
        <i class="fas fa-brain"></i>
        Modèles d'IA disponibles
      </div>
      
      <div class="model-options" id="modelOptions">
        <!-- Les options de modèle seront générées dynamiquement -->
      </div>
      
      <div class="current-model-display">
        <div class="current-model-label">Modèle actuellement sélectionné :</div>
        <div class="current-model-value" id="currentModelDisplay">Gemma 3 27B (Google) - gratuit</div>
      </div>
    </div>
  </div>

  <!-- Popup d'édition de modèle -->
  <div class="edit-model-overlay" id="editModelOverlay">
    <div class="edit-model-popup">
      <div class="settings-header">
        <div class="settings-title">
          <i class="fas fa-edit"></i>
          Modifier le modèle
        </div>
        <button class="close-btn" onclick="closeEditModel()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="form-group">
        <label for="editModelId">ID du modèle</label>
        <input type="text" id="editModelId" />
      </div>
      
      <div class="form-group">
        <label for="editModelName">Nom du modèle</label>
        <input type="text" id="editModelName" />
      </div>
      
      <div class="form-group">
        <label for="editModelProvider">Fournisseur</label>
        <input type="text" id="editModelProvider" />
      </div>
      
      <div class="form-group">
        <label for="editModelType">Type</label>
        <select id="editModelType">
          <option value="gratuit">Gratuit</option>
          <option value="payant">Payant</option>
          <option value="preview">Preview</option>
          <option value="personnalisé">Personnalisé</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="editModelDescription">Description</label>
        <textarea id="editModelDescription"></textarea>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="export-btn" onclick="saveModelEdit()" style="flex: 1;">
          <i class="fas fa-save"></i> Sauvegarder
        </button>
        <button class="export-btn" onclick="closeEditModel()" style="flex: 1; background: rgba(197, 48, 48, 0.2);">
          <i class="fas fa-times"></i> Annuler
        </button>
      </div>
    </div>
  </div>
  
  <div class="container">
    <div class="header-section">
      <button class="settings-btn" onclick="openSettings()">
        <i class="fas fa-cog"></i>
      </button>
      <h1><i class="fas fa-hard-hat"></i> Expert Risques Professionnels</h1>
      <p class="subtitle">Solution multisectorielle pour l'analyse détaillée des risques et les plans de prévention</p>
    </div>

    <!-- Nouveau panneau de configuration -->
    <div class="configuration-panel">
      <div class="config-title">
        <i class="fas fa-sliders-h"></i>
        Configuration de l'analyse
      </div>
      
      <div class="form-group">
        <label for="sectorSelect">
          <i class="fas fa-industry label-icon"></i>
          Secteur d'activité
        </label>
        <div class="sector-selector">
          <button class="sector-btn active" data-sector="btp" onclick="selectSector('btp')" style="--sector-color: var(--sector-btp)">
            <i class="fas fa-hard-hat"></i> BTP
          </button>
          <button class="sector-btn" data-sector="industrie" onclick="selectSector('industrie')" style="--sector-color: var(--sector-industrie)">
            <i class="fas fa-cogs"></i> Industrie
          </button>
          <button class="sector-btn" data-sector="tertiaire" onclick="selectSector('tertiaire')" style="--sector-color: var(--sector-tertiaire)">
            <i class="fas fa-building"></i> Tertiaire
          </button>
          <button class="sector-btn" data-sector="agricole" onclick="selectSector('agricole')" style="--sector-color: var(--sector-agricole)">
            <i class="fas fa-tractor"></i> Agricole
          </button>
          <button class="sector-btn" data-sector="sante" onclick="selectSector('sante')" style="--sector-color: var(--sector-sante)">
            <i class="fas fa-hospital"></i> Santé
          </button>
        </div>
      </div>
      
      <!-- Informations réglementaires par secteur -->
      <div class="reglementation-info" id="reglementationInfo">
        <div class="reg-title">
          <i class="fas fa-gavel"></i>
          <span id="regTitle">Réglementation BTP</span>
        </div>
        <div class="reg-content" id="regContent">
          Code du travail, Code de la construction, Décret CMR, Règlementation amiante, Équipements de protection individuelle...
        </div>
      </div>
    </div>

    <div class="function-selector">
      <button class="function-btn active" onclick="selectFunction('risk')">
        <i class="fas fa-search"></i> Analyse des Risques
      </button>
      <button class="function-btn" onclick="selectFunction('prevention')">
        <i class="fas fa-shield-alt"></i> Plan de Prévention
      </button>
    </div>

    <div class="input-grid">
      <div class="form-group">
        <label for="job"><i class="fas fa-tools label-icon"></i> Métier ou tâche</label>
        <input type="text" id="job" placeholder="Ex: Démolition de cloison, Maintenance machine, Travail sur écran..." required />
      </div>

      <div class="form-group">
        <label for="location"><i class="fas fa-map-marker-alt label-icon"></i> Lieu spécifique</label>
        <input type="text" id="location" placeholder="Ex: Chantier, Atelier, Bureau, Exploitation agricole..." required />
      </div>

      <div class="form-group" style="grid-column: 1 / -1;">
        <label for="details"><i class="fas fa-info-circle label-icon"></i> Conditions ou précisions (facultatif)</label>
        <textarea id="details" placeholder="Ex: Présence de produits chimiques, espace confiné, horaires de nuit, conditions météo, public présent..."></textarea>
      </div>
    </div>

    <div class="btn-group">
      <button class="btn btn-analyze" onclick="analyzeWithAI()">
        <i class="fas fa-search"></i> Analyser les risques
      </button>
    </div>

    <div class="export-options" id="exportOptions">
      <button class="export-btn" onclick="exportAsText()">
        <i class="fas fa-file-alt"></i> Exporter en .txt
      </button>
      <button class="export-btn" onclick="exportAsRTF()">
        <i class="fas fa-file-word"></i> Exporter en .rtf
      </button>
    </div>

    <div id="status" class="status"></div>
    
    <div id="preview">
      <div class="preview-header">
        <div class="preview-title" id="previewTitle">Analyse des Risques</div>
        <div class="preview-subtitle" id="previewSubtitle">Résultat de l'analyse généré automatiquement</div>
      </div>
      <div id="previewContent"></div>
    </div>
  </div>

  <script>
    // Créer des éléments flottants pour l'arrière-plan
    function createFloatingElements() {
      const container = document.getElementById('floatingElements');
      const colors = ['rgba(0, 198, 255, 0.1)', 'rgba(15, 76, 117, 0.1)', 'rgba(46, 125, 50, 0.1)'];
      
      for (let i = 0; i < 20; i++) {
        const element = document.createElement('div');
        const size = Math.random() * 100 + 20;
        const color = colors[Math.floor(Math.random() * colors.length)];
        
        element.className = 'floating-element';
        element.style.width = `${size}px`;
        element.style.height = `${size}px`;
        element.style.background = color;
        element.style.left = `${Math.random() * 100}%`;
        element.style.top = `${Math.random() * 100 + 100}%`;
        element.style.animationDuration = `${Math.random() * 20 + 15}s`;
        element.style.animationDelay = `${Math.random() * 5}s`;
        
        container.appendChild(element);
      }
      
      // Ajouter des points pulsants
      for (let i = 0; i < 10; i++) {
        const dot = document.createElement('div');
        dot.className = 'pulse-dot';
        dot.style.left = `${Math.random() * 100}%`;
        dot.style.top = `${Math.random() * 100}%`;
        dot.style.animationDelay = `${Math.random() * 2}s`;
        container.appendChild(dot);
      }
    }

    // Déclaration de l'API_KEY mutable
    let API_KEY = localStorage.getItem('openRouterApiKey') || "";
    const API_URL = "https://openrouter.ai/api/v1/chat/completions";

    let currentRawResponse = "";
    let currentFunction = "risk";
    let currentEditingModel = null;
    let currentSector = "btp";

    // Configuration des secteurs avec réglementations spécifiques
    const sectorsConfig = {
      btp: {
        name: "Bâtiment et Travaux Publics",
        color: "var(--sector-btp)",
        icon: "fas fa-hard-hat",
        regulations: {
          title: "Réglementation BTP - Principaux textes",
          content: "Code du travail, Code de la construction, Décret CMR (91-1417), Règlementation amiante (2012-639), Équipements de protection individuelle, Plan de prévention, Protocole de sécurité."
        },
        riskSections: {
          'Description sommaire des travaux': {
            icon: 'fas fa-clipboard-list',
            color: 'var(--risk-description)',
            subtitle: 'Résumé détaillé des éléments renseignés par l\'utilisateur'
          },
          'Risques physiques et mécaniques': {
            icon: 'fas fa-running',
            color: 'var(--risk-physical)',
            subtitle: 'Chutes de hauteur, heurts, écrasement, bruit, vibrations, accidents machines/outils/engins'
          },
          'Risques chimiques et biologiques': {
            icon: 'fas fa-flask',
            color: 'var(--risk-chemical)',
            subtitle: 'Amiante, plomb, poussières de silice, solvants, résines, gaz, moisissures, légionelles'
          },
          'Contraintes ergonomiques et physiques': {
            icon: 'fas fa-user-injured',
            color: 'var(--risk-ergonomic)',
            subtitle: 'Mauvaises postures, manutentions manuelles, tâches répétitives, charges lourdes, efforts prolongés'
          },
          'Risques environnementaux et climatiques': {
            icon: 'fas fa-cloud-showers-heavy',
            color: 'var(--risk-environmental)',
            subtitle: 'Conditions météorologiques, températures extrêmes, intempéries, présence de réseaux enterrés'
          },
          'Risques liés aux activités des tiers': {
            icon: 'fas fa-users',
            color: 'var(--risk-third-party)',
            subtitle: 'Coactivité, circulation engins, piétons, interfaces entre entreprises, sous-traitance'
          },
          'Organisation et coordination des travaux': {
            icon: 'fas fa-sitemap',
            color: 'var(--risk-organization)',
            subtitle: 'Planification, signalisation, procédures d\'urgence, premiers secours, consignation'
          },
          'Mesures de prévention techniques et organisationnelles': {
            icon: 'fas fa-shield-alt',
            color: 'var(--risk-prevention)',
            subtitle: 'Protections collectives, EPI, formation, suivi médical, management de la sécurité'
          }
        },
        preventionSections: {
          'Description détaillée des travaux': {
            icon: 'fas fa-clipboard-list',
            color: 'var(--prevention-description)',
            subtitle: 'Analyse complète du contexte et des spécificités du chantier'
          },
          'Identification exhaustive des activités et des risques': {
            icon: 'fas fa-search',
            color: 'var(--prevention-identification)',
            subtitle: 'Phases d\'activité dangereuses et moyens de prévention spécifiques détaillés'
          },
          'Matériels, installations et dispositifs de sécurité': {
            icon: 'fas fa-tools',
            color: 'var(--prevention-materials)',
            subtitle: 'Adaptation des matériels et conditions d\'entretien avec spécifications techniques'
          },
          'Instructions et consignes détaillées aux travailleurs': {
            icon: 'fas fa-user-shield',
            color: 'var(--prevention-instructions)',
            subtitle: 'Consignes de sécurité complètes pour assurer la protection des travailleurs'
          },
          'Organisation des secours et procédures d\'urgence': {
            icon: 'fas fa-first-aid',
            color: 'var(--prevention-rescue)',
            subtitle: 'Dispositif de premiers secours détaillé en cas d\'urgence'
          },
          'Coordination et interfaces entre entreprises': {
            icon: 'fas fa-handshake',
            color: 'var(--prevention-coordination)',
            subtitle: 'Commandement et coordination des travaux entre entreprises avec planning'
          },
          'Répartition des responsabilités et suivi individualisé': {
            icon: 'fas fa-tasks',
            color: 'var(--prevention-responsibilities)',
            subtitle: 'Répartition détaillée des charges et suivi individuel de santé'
          },
          'Informations spécifiques et réglementation technique': {
            icon: 'fas fa-exclamation-triangle',
            color: 'var(--prevention-asbestos)',
            subtitle: 'Dossiers techniques, rapports de repérage, études de sécurité complètes'
          }
        }
      },
      industrie: {
        name: "Industrie",
        color: "var(--sector-industrie)",
        icon: "fas fa-cogs",
        regulations: {
          title: "Réglementation Industrie - Principaux textes",
          content: "Code du travail, Directive Machines 2006/42/CE, ATEX (atmosphères explosives), REACH (produits chimiques), ICPE (installations classées), Maintenance des équipements."
        },
        riskSections: {
          'Description détaillée des opérations industrielles': {
            icon: 'fas fa-clipboard-list',
            color: 'var(--risk-description)',
            subtitle: 'Analyse complète des activités industrielles à réaliser'
          },
          'Risques machines, équipements et installations': {
            icon: 'fas fa-cog',
            color: '#ff6b6b',
            subtitle: 'Pièces en mouvement, énergies, maintenance, conformité CE, vérifications réglementaires'
          },
          'Risques chimiques, ATEX et produits dangereux': {
            icon: 'fas fa-vial',
            color: '#4ecdc4',
            subtitle: 'Produits dangereux, atmosphères explosives, étiquetage CLP, fiches de données sécurité'
          },
          'Risques électriques, énergies et fluides': {
            icon: 'fas fa-bolt',
            color: '#ffe66d',
            subtitle: 'Haute tension, courants forts, consignation, habilitation, réseaux fluides'
          },
          'Risques thermiques, incendie et explosion': {
            icon: 'fas fa-fire',
            color: '#ff9800',
            subtitle: 'Températures extrêmes, sources d\'ignition, moyens d\'extinction, classement ERP'
          },
          'Organisation, procédures et modes opératoires': {
            icon: 'fas fa-sitemap',
            color: '#9c27b0',
            subtitle: 'Permis de travail, procédures opératoires, signalisation, lock-out tag-out'
          },
          'Environnement industriel et ambiances de travail': {
            icon: 'fas fa-industry',
            color: '#607d8b',
            subtitle: 'Bruit, éclairage, ventilation, ambiances thermiques, qualité de l\'air'
          },
          'Mesures de prévention techniques et organisationnelles': {
            icon: 'fas fa-shield-alt',
            color: '#2e7d32',
            subtitle: 'Protections collectives, EPI, formation spécifique, maintenance préventive'
          }
        },
        preventionSections: {
          'Description détaillée des opérations': {
            icon: 'fas fa-clipboard-list',
            color: 'var(--prevention-description)',
            subtitle: 'Analyse exhaustive des activités industrielles'
          },
          'Analyse détaillée des risques machines': {
            icon: 'fas fa-cog',
            color: '#e91e63',
            subtitle: 'Documentation technique complète, procédures de consignation détaillées'
          },
          'Gestion approfondie des produits chimiques': {
            icon: 'fas fa-vial',
            color: '#2196f3',
            subtitle: 'Fiches de données sécurité, stockage réglementaire, manipulation sécurisée'
          },
          'Procédures opératoires détaillées': {
            icon: 'fas fa-file-alt',
            color: '#4caf50',
            subtitle: 'Instructions détaillées pour chaque opération avec check-lists'
          },
          'Organisation complète des secours industriels': {
            icon: 'fas fa-first-aid',
            color: '#ff5722',
            subtitle: 'Plan d\'intervention détaillé, équipes de première intervention formées'
          },
          'Maintenance et vérifications réglementaires': {
            icon: 'fas fa-tools',
            color: '#9c27b0',
            subtitle: 'Planning de maintenance préventive, registre de sécurité exhaustif'
          },
          'Formation et habilitations spécifiques': {
            icon: 'fas fa-user-graduate',
            color: '#607d8b',
            subtitle: 'Compétences requises détaillées, formations spécifiques réglementaires'
          },
          'Surveillance médicale et suivi des expositions': {
            icon: 'fas fa-stethoscope',
            color: '#795548',
            subtitle: 'Visite médicale adaptée, suivi des expositions spécifiques, traçabilité'
          }
        }
      },
      tertiaire: {
        name: "Tertiaire",
        color: "var(--sector-tertiaire)",
        icon: "fas fa-building",
        regulations: {
          title: "Réglementation Tertiaire - Principaux textes",
          content: "Code du travail, Décret écrans 91-451, RPS (risques psychosociaux), Document Unique, Aménagement des espaces de travail, Accessibilité, Sécurité incendie ERP."
        },
        riskSections: {
          'Description détaillée des activités tertiaires': {
            icon: 'fas fa-clipboard-list',
            color: 'var(--risk-description)',
            subtitle: 'Analyse exhaustive des tâches de bureau ou de service'
          },
          'Risques psychosociaux et organisationnels': {
            icon: 'fas fa-brain',
            color: '#7b1fa2',
            subtitle: 'Stress, charge mentale, relations de travail, organisation, harcèlement, burn-out'
          },
          'Risques liés aux écrans et à la sédentarité': {
            icon: 'fas fa-desktop',
            color: '#2196f3',
            subtitle: 'Fatigue visuelle, troubles musculosquelettiques, sédentarité, postures statiques'
          },
          'Ergonomie du poste et aménagement des espaces': {
            icon: 'fas fa-chair',
            color: '#4caf50',
            subtitle: 'Aménagement, mobilier adapté, posture, environnement lumineux, acoustique'
          },
          'Risques incendie et sécurité des établissements': {
            icon: 'fas fa-fire-extinguisher',
            color: '#ff5722',
            subtitle: 'Dégagements, alarmes, extincteurs, exercices d\'évacuation, registre de sécurité'
          },
          'Environnement de travail et qualité de vie': {
            icon: 'fas fa-temperature-low',
            color: '#00bcd4',
            subtitle: 'Qualité de l\'air, bruit, température, éclairage, espaces communs, restauration'
          },
          'Déplacements, accueil et espaces publics': {
            icon: 'fas fa-walking',
            color: '#795548',
            subtitle: 'Circulation, espaces publics, accès personnes handicapées, signalétique'
          },
          'Prévention tertiaire et management de la QVT': {
            icon: 'fas fa-shield-alt',
            color: '#2e7d32',
            subtitle: 'Formation, sensibilisation, aménagement des espaces, qualité de vie au travail'
          }
        },
        preventionSections: {
          'Description détaillée des activités': {
            icon: 'fas fa-clipboard-list',
            color: 'var(--prevention-description)',
            subtitle: 'Analyse exhaustive des tâches de bureau ou de service'
          },
          'Évaluation approfondie des RPS': {
            icon: 'fas fa-brain',
            color: '#e91e63',
            subtitle: 'Analyse organisationnelle détaillée, indicateurs de stress, enquêtes climat social'
          },
          'Aménagement ergonomique des postes': {
            icon: 'fas fa-desktop',
            color: '#2196f3',
            subtitle: 'Ergonomie complète, mobilier adapté, pauses régulières, exercices de relaxation'
          },
          'Procédures de sécurité et plans d\'urgence': {
            icon: 'fas fa-file-shield',
            color: '#4caf50',
            subtitle: 'Consignes incendie détaillées, plans d\'évacuation, accueil sécurisé'
          },
          'Organisation du travail et management': {
            icon: 'fas fa-users-cog',
            color: '#ff5722',
            subtitle: 'Horaires adaptés, charge de travail, autonomie, reconnaissance, feedback'
          },
          'Formation continue et information': {
            icon: 'fas fa-user-graduate',
            color: '#9c27b0',
            subtitle: 'Sensibilisation RPS détaillée, gestes et postures, sécurité informatique'
          },
          'Surveillance médicale et suivi santé': {
            icon: 'fas fa-stethoscope',
            color: '#607d8b',
            subtitle: 'Visite médicale adaptée, suivi des TMS et RPS, absentéisme'
          },
          'Amélioration continue et indicateurs': {
            icon: 'fas fa-chart-line',
            color: '#795548',
            subtitle: 'Enquêtes satisfaction détaillées, indicateurs de prévention, tableaux de bord'
          }
        }
      },
      agricole: {
        name: "Agricole",
        color: "var(--sector-agricole)",
        icon: "fas fa-tractor",
        regulations: {
          title: "Réglementation Agricole - Principaux textes",
          content: "Code rural, MSA (Mutualité Sociale Agricole), Produits phytosanitaires, Machines agricoles, Élevage, Explosifs agricoles, Bâtiments d'exploitation."
        },
        riskSections: {
          'Description détaillée des travaux agricoles': {
            icon: 'fas fa-clipboard-list',
            color: 'var(--risk-description)',
            subtitle: 'Analyse exhaustive des activités agricoles à réaliser'
          },
          'Risques machines et équipements agricoles': {
            icon: 'fas fa-tractor',
            color: '#8d6e63',
            subtitle: 'Tracteurs, moissonneuses, outils, maintenance, retournements, protections'
          },
          'Risques chimiques et produits phytosanitaires': {
            icon: 'fas fa-spray-can',
            color: '#4caf50',
            subtitle: 'Produits phytosanitaires, engrais, manipulation, stockage, épandage, pulvérisation'
          },
          'Risques animaux, biologiques et zoonoses': {
            icon: 'fas fa-paw',
            color: '#795548',
            subtitle: 'Élevage, zoonoses, manipulations animales, contention, bâtiments d\'élevage'
          },
          'Risques environnementaux et conditions extérieures': {
            icon: 'fas fa-tree',
            color: '#388e3c',
            subtitle: 'Conditions météo, relief, isolement, interventions, intempéries, saisonnalité'
          },
          'Risques liés aux bâtiments et installations': {
            icon: 'fas fa-warehouse',
            color: '#ff9800',
            subtitle: 'Silos, stockages, atmosphères confinées, éclairage, ventilation, gaz'
          },
          'Organisation des travaux et saisonnalité': {
            icon: 'fas fa-sitemap',
            color: '#9c27b0',
            subtitle: 'Planification, saisonnalité, travail isolé, urgence, communication'
          },
          'Prévention agricole et formation MSA': {
            icon: 'fas fa-shield-alt',
            color: '#2e7d32',
            subtitle: 'Formation MSA détaillée, équipements adaptés, suivi médical spécifique'
          }
        },
        preventionSections: {
          'Description détaillée des travaux': {
            icon: 'fas fa-clipboard-list',
            color: 'var(--prevention-description)',
            subtitle: 'Analyse exhaustive des activités agricoles'
          },
          'Sécurité approfondie des machines': {
            icon: 'fas fa-tractor',
            color: '#e91e63',
            subtitle: 'Vérifications détaillées, entretien rigoureux, formations spécifiques adaptées'
          },
          'Gestion rigoureuse des produits phytosanitaires': {
            icon: 'fas fa-spray-can',
            color: '#2196f3',
            subtitle: 'Certiphyto obligatoire, équipements de protection complets, stockage réglementaire'
          },
          'Protection des animaux et prévention des accidents': {
            icon: 'fas fa-paw',
            color: '#4caf50',
            subtitle: 'Comportement animal étudié, installations adaptées, procédures de contention'
          },
          'Organisation détaillée des secours': {
            icon: 'fas fa-first-aid',
            color: '#ff5722',
            subtitle: 'Plan d\'intervention spécifique, moyens de communication adaptés, isolement'
          },
          'Formation et habilitations agricoles': {
            icon: 'fas fa-user-graduate',
            color: '#9c27b0',
            subtitle: 'Certificats obligatoires, agréments spécifiques, formations MSA complètes'
          },
          'Surveillance médicale renforcée': {
            icon: 'fas fa-stethoscope',
            color: '#607d8b',
            subtitle: 'Visite médicale adaptée, suivi des expositions spécifiques, traçabilité'
          },
          'Amélioration continue des pratiques': {
            icon: 'fas fa-seedling',
            color: '#795548',
            subtitle: 'Innovations techniques, prévention intégrée, agriculture durable et sûre'
          }
        }
      },
      sante: {
        name: "Santé et Médico-social",
        color: "var(--sector-sante)",
        icon: "fas fa-hospital",
        regulations: {
          title: "Réglementation Santé - Principaux textes",
          content: "Code de la santé publique, Décret risques biologiques, Produits de santé, Hygiène hospitalière, Gestes et postures, Risques psychosociaux, Dossier médical."
        },
        riskSections: {
          'Description détaillée des activités de soins': {
            icon: 'fas fa-clipboard-list',
            color: 'var(--risk-description)',
            subtitle: 'Analyse exhaustive des soins ou services à réaliser'
          },
          'Risques biologiques et infectieux': {
            icon: 'fas fa-biohazard',
            color: '#d32f2f',
            subtitle: 'Agents pathogènes, prélèvements, déchets infectieux, AES, vaccination, isolement'
          },
          'Risques chimiques et produits de santé': {
            icon: 'fas fa-pills',
            color: '#7b1fa2',
            subtitle: 'Médicaments, désinfectants, produits de contraste, CMR, cytotoxiques, anesthésiques'
          },
          'Risques liés aux patients et à la manutention': {
            icon: 'fas fa-procedures',
            color: '#1976d2',
            subtitle: 'Manutention des patients, agitation, comportements, dépendance, contention'
          },
          'Risques organisationnels et psychosociaux': {
            icon: 'fas fa-user-clock',
            color: '#388e3c',
            subtitle: 'Horaires décalés, charge de travail, stress, relations, burn-out, urgences'
          },
          'Risques techniques et équipements médicaux': {
            icon: 'fas fa-x-ray',
            color: '#f57c00',
            subtitle: 'Équipements médicaux, rayonnements, maintenance, informatique, biomédical'
          },
          'Environnement de soins et hygiène': {
            icon: 'fas fa-hand-sparkles',
            color: '#00838f',
            subtitle: 'Hygiène, asepsie, circuits, nettoyage, stérilisation, décontamination'
          },
          'Prévention en santé et sécurité des soins': {
            icon: 'fas fa-shield-alt',
            color: '#2e7d32',
            subtitle: 'Vaccination, EPI adaptés, formation continue, protocoles, gestion des risques'
          }
        },
        preventionSections: {
          'Description détaillée des activités': {
            icon: 'fas fa-clipboard-list',
            color: 'var(--prevention-description)',
            subtitle: 'Analyse exhaustive des soins ou services'
          },
          'Gestion rigoureuse des risques biologiques': {
            icon: 'fas fa-biohazard',
            color: '#e91e63',
            subtitle: 'Protocoles d\'hygiène stricts, vaccination obligatoire, équipements de protection'
          },
          'Sécurité des soins et traçabilité': {
            icon: 'fas fa-hand-holding-medical',
            color: '#2196f3',
            subtitle: 'Procédures détaillées, check-lists sécurité, traçabilité complète, bonnes pratiques'
          },
          'Manutention des patients et ergonomie': {
            icon: 'fas fa-people-carry',
            color: '#4caf50',
            subtitle: 'Techniques validées, aides mécaniques adaptées, formation continue, évaluation'
          },
          'Organisation des secours et urgences': {
            icon: 'fas fa-ambulance',
            color: '#ff5722',
            subtitle: 'Plan blanc détaillé, urgences organisées, équipes mobiles, simulation'
          },
          'Formation continue et compétences': {
            icon: 'fas fa-user-md',
            color: '#9c27b0',
            subtitle: 'Compétences certifiées, protocoles maîtrisés, gestes techniques, simulation'
          },
          'Surveillance médicale du personnel': {
            icon: 'fas fa-stethoscope',
            color: '#607d8b',
            subtitle: 'Visite médicale adaptée, suivi des expositions, vaccination, santé au travail'
          },
          'Amélioration continue de la qualité': {
            icon: 'fas fa-clipboard-check',
            color: '#795548',
            subtitle: 'Indicateurs qualité, retours d\'expérience, certification, gestion des risques'
          }
        }
      }
    };

    // Configuration des modèles d'IA par défaut
    const defaultAiModels = [
      {
        id: 'google/gemma-3-27b-it:free',
        name: 'Gemma 3 27B',
        provider: 'Google',
        type: 'gratuit',
        description: 'Modèle performant de Google, idéal pour les analyses détaillées',
        custom: false
      },
      {
        id: 'mistralai/mistral-small-3.2-24b-instruct:free',
        name: 'Mistral Small 3.2 24B',
        provider: 'Mistral AI',
        type: 'gratuit',
        description: 'Modèle français équilibré entre vitesse et qualité',
        custom: false
      },
      {
        id: 'openai/gpt-oss-20b:free',
        name: 'GPT OSS 20B',
        provider: 'OpenAI',
        type: 'gratuit',
        description: 'Version open source de GPT, fiable et rapide',
        custom: false
      },
      {
        id: 'google/gemini-2.5-flash-lite-preview-06-17',
        name: 'Gemini 2.5 Flash Lite',
        provider: 'Google',
        type: 'preview',
        description: 'Version preview rapide et efficace',
        custom: false
      },
      {
        id: 'deepseek/deepseek-r1-0528-qwen3-8b:free',
        name: 'DeepSeek R1 Qwen3 8B',
        provider: 'DeepSeek',
        type: 'gratuit',
        description: 'Modèle de raisonnement spécialisé pour analyses complexes',
        custom: false
      },
      {
        id: 'z-ai/glm-4.5-air:free',
        name: 'GLM 4.5 Air',
        provider: 'Z-AI',
        type: 'gratuit',
        description: 'Modèle léger et efficace pour analyses rapides',
        custom: false
      },
      {
        id: 'google/gemma-3n-e2b-it:free',
        name: 'Gemma 3N E2B',
        provider: 'Google',
        type: 'gratuit',
        description: 'Version optimisée pour les tâches professionnelles',
        custom: false
      }
    ];

    // Charger tous les modèles depuis le localStorage
    function getAllModels() {
      const customModels = JSON.parse(localStorage.getItem('customAiModels') || '[]');
      const modifiedDefaultModels = JSON.parse(localStorage.getItem('modifiedDefaultModels') || '[]');
      
      // Fusionner les modèles modifiés avec les modèles par défaut
      const defaultModels = defaultAiModels.map(defaultModel => {
        const modified = modifiedDefaultModels.find(m => m.originalId === defaultModel.id);
        return modified ? { ...modified, custom: false } : defaultModel;
      });
      
      return [...defaultModels, ...customModels];
    }

    // Sauvegarder les modèles personnalisés
    function saveCustomModels(customModels) {
      localStorage.setItem('customAiModels', JSON.stringify(customModels));
    }

    // Sauvegarder les modèles par défaut modifiés
    function saveModifiedDefaultModels(modifiedModels) {
      localStorage.setItem('modifiedDefaultModels', JSON.stringify(modifiedModels));
    }

    // Fonction pour sélectionner le secteur
    function selectSector(sector) {
      currentSector = sector;
      
      // Mettre à jour les boutons
      document.querySelectorAll('.sector-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Mettre à jour les informations réglementaires
      updateReglementationInfo();
      
      // Mettre à jour l'interface avec la couleur du secteur
      updateSectorTheme();
    }

    // Fonction pour mettre à jour les informations réglementaires
    function updateReglementationInfo() {
      const sectorConfig = sectorsConfig[currentSector];
      const regInfo = document.getElementById('reglementationInfo');
      const regTitle = document.getElementById('regTitle');
      const regContent = document.getElementById('regContent');
      
      regTitle.textContent = sectorConfig.regulations.title;
      regContent.textContent = sectorConfig.regulations.content;
      regInfo.classList.add('active');
    }

    // Fonction pour mettre à jour le thème selon le secteur
    function updateSectorTheme() {
      const sectorConfig = sectorsConfig[currentSector];
      document.documentElement.style.setProperty('--primary', sectorConfig.color);
    }

    // Fonction pour sélectionner la fonctionnalité
    function selectFunction(functionType) {
      currentFunction = functionType;
      
      // Mettre à jour les boutons
      document.querySelectorAll('.function-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Mettre à jour le texte du bouton d'analyse
      const analyzeBtn = document.querySelector('.btn-analyze');
      if (functionType === 'risk') {
        analyzeBtn.innerHTML = '<i class="fas fa-search"></i> Analyser les risques';
        document.querySelector('h1').innerHTML = `<i class="fas fa-hard-hat"></i> Analyse des Risques - ${sectorsConfig[currentSector].name}`;
        document.querySelector('.subtitle').textContent = `Solution professionnelle pour l'analyse détaillée et la prévention des risques dans le ${sectorsConfig[currentSector].name}`;
      } else {
        analyzeBtn.innerHTML = '<i class="fas fa-shield-alt"></i> Générer le plan de prévention';
        document.querySelector('h1').innerHTML = `<i class="fas fa-shield-alt"></i> Plan de Prévention - ${sectorsConfig[currentSector].name}`;
        document.querySelector('.subtitle').textContent = `Solution professionnelle pour l'élaboration de plans de prévention complets dans le ${sectorsConfig[currentSector].name}`;
      }
      
      // Réinitialiser l'affichage
      document.getElementById('preview').style.display = 'none';
      document.getElementById('exportOptions').style.display = 'none';
    }

    // Fonctions pour le popup de paramètres
    function openSettings() {
      const overlay = document.getElementById('settingsOverlay');
      overlay.style.display = 'flex';
      populateModelOptions();
      loadApiKey();
    }

    function closeSettings() {
      const overlay = document.getElementById('settingsOverlay');
      overlay.style.display = 'none';
    }

    // Fonctions pour gérer l'API Key
    function toggleApiKeyVisibility() {
      const apiKeyInput = document.getElementById('apiKeyInput');
      const toggleIcon = document.querySelector('.toggle-password i');
      
      if (apiKeyInput.type === 'password') {
        apiKeyInput.type = 'text';
        toggleIcon.className = 'fas fa-eye-slash';
      } else {
        apiKeyInput.type = 'password';
        toggleIcon.className = 'fas fa-eye';
      }
    }

    function saveApiKey() {
      const apiKey = document.getElementById('apiKeyInput').value.trim();
      const statusDiv = document.getElementById('apiStatus');
      
      if (!apiKey) {
        statusDiv.className = 'api-status error';
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Veuillez saisir une clé API';
        return;
      }
      
      // Vérifier le format basique de la clé API
      if (!apiKey.startsWith('sk-or-')) {
        statusDiv.className = 'api-status error';
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Format de clé API invalide (doit commencer par sk-or-)';
        return;
      }
      
      // Sauvegarder la clé API
      localStorage.setItem('openRouterApiKey', apiKey);
      API_KEY = apiKey;
      
      statusDiv.className = 'api-status success';
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Clé API sauvegardée avec succès';
      
      // Masquer après 3 secondes
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 3000);
    }

    function testApiKey() {
      const apiKeyInput = document.getElementById('apiKeyInput');
      const apiKey = apiKeyInput.value.trim();
      const statusDiv = document.getElementById('apiStatus');
      
      if (!apiKey) {
        statusDiv.className = 'api-status error';
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Aucune clé API à tester';
        return;
      }
      
      // Vérifier le format
      if (!apiKey.startsWith('sk-or-')) {
        statusDiv.className = 'api-status error';
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Format de clé API invalide';
        return;
      }
      
      statusDiv.className = 'api-status testing';
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Test de la clé API en cours...';
      
      // Tester l'API avec une requête simple
      fetch('https://openrouter.ai/api/v1/auth/key', {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${apiKey}`
        }
      })
      .then(response => {
        if (response.ok) {
          statusDiv.className = 'api-status success';
          statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Clé API valide ! Connexion réussie.';
          // Sauvegarder automatiquement si le test réussit
          saveApiKeyFromTest(apiKey);
        } else {
          throw new Error('Clé API invalide ou non autorisée');
        }
      })
      .catch(error => {
        statusDiv.className = 'api-status error';
        statusDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> Erreur : ${error.message}`;
      });
    }

    // Fonction pour sauvegarder après un test réussi
    function saveApiKeyFromTest(apiKey) {
      localStorage.setItem('openRouterApiKey', apiKey);
      API_KEY = apiKey;
    }

    function clearApiKey() {
      if (confirm('Êtes-vous sûr de vouloir effacer la clé API ? L\'analyse ne fonctionnera plus sans clé API valide.')) {
        localStorage.removeItem('openRouterApiKey');
        document.getElementById('apiKeyInput').value = '';
        API_KEY = ""; // IMPORTANT: Mettre une chaîne vide
        
        const statusDiv = document.getElementById('apiStatus');
        statusDiv.className = 'api-status success';
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Clé API effacée. L\'analyse est désormais désactivée.';
        
        setTimeout(() => {
          statusDiv.style.display = 'none';
        }, 4000);
      }
    }

    function loadApiKey() {
      const savedApiKey = localStorage.getItem('openRouterApiKey');
      if (savedApiKey) {
        document.getElementById('apiKeyInput').value = savedApiKey;
        API_KEY = savedApiKey; // Mettre à jour la variable globale
        updateApiKeyCounter();
      } else {
        // Si aucune clé n'est sauvegardée, on désactive l'API
        API_KEY = "";
        document.getElementById('apiKeyInput').value = '';
        updateApiKeyCounter();
      }
    }

    function updateApiKeyCounter() {
      const input = document.getElementById('apiKeyInput');
      const counter = document.getElementById('apiKeyCounter');
      if (input && counter) {
        counter.textContent = `${input.value.length} caractères`;
        
        if (input.value.length > 0 && !input.value.startsWith('sk-or-')) {
          counter.className = 'char-counter warning';
        } else {
          counter.className = 'char-counter';
        }
      }
    }

    // Fonctions pour gérer les modèles
    function addCustomModel() {
      const modelId = document.getElementById('modelIdInput').value.trim();
      
      if (!modelId) {
        alert('Veuillez saisir l\'ID du modèle OpenRouter.');
        return;
      }
      
      // Extraire le nom et le fournisseur de l'ID
      const parts = modelId.split('/');
      const provider = parts[0] || 'Inconnu';
      const modelName = parts[1] || modelId;
      
      const newModel = {
        id: modelId,
        name: modelName,
        provider: provider,
        type: 'personnalisé',
        description: 'Modèle personnalisé ajouté par l\'utilisateur',
        custom: true
      };
      
      // Charger les modèles personnalisés existants
      const customModels = JSON.parse(localStorage.getItem('customAiModels') || '[]');
      
      // Vérifier si le modèle existe déjà
      if (customModels.some(model => model.id === modelId)) {
        alert('Ce modèle existe déjà dans votre liste.');
        return;
      }
      
      // Ajouter le nouveau modèle
      customModels.push(newModel);
      saveCustomModels(customModels);
      
      // Réinitialiser le formulaire
      document.getElementById('modelIdInput').value = '';
      
      // Mettre à jour l'affichage
      populateModelOptions();
      
      // Afficher un message de succès
      const statusDiv = document.getElementById('apiStatus');
      statusDiv.className = 'api-status success';
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Modèle personnalisé ajouté avec succès !';
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 3000);
    }

    function editModel(modelId) {
      const allModels = getAllModels();
      const model = allModels.find(m => m.id === modelId);
      
      if (!model) return;
      
      currentEditingModel = model;
      
      // Remplir le formulaire d'édition
      document.getElementById('editModelId').value = model.id;
      document.getElementById('editModelName').value = model.name;
      document.getElementById('editModelProvider').value = model.provider;
      document.getElementById('editModelType').value = model.type;
      document.getElementById('editModelDescription').value = model.description;
      
      // Afficher le popup d'édition
      document.getElementById('editModelOverlay').style.display = 'flex';
    }

    function saveModelEdit() {
      const modelId = document.getElementById('editModelId').value.trim();
      const modelName = document.getElementById('editModelName').value.trim();
      const modelProvider = document.getElementById('editModelProvider').value.trim();
      const modelType = document.getElementById('editModelType').value;
      const modelDescription = document.getElementById('editModelDescription').value.trim();
      
      if (!modelId || !modelName || !modelProvider) {
        alert('Veuillez remplir tous les champs obligatoires.');
        return;
      }
      
      const updatedModel = {
        id: modelId,
        name: modelName,
        provider: modelProvider,
        type: modelType,
        description: modelDescription,
        custom: currentEditingModel.custom
      };
      
      if (currentEditingModel.custom) {
        // Modifier un modèle personnalisé
        const customModels = JSON.parse(localStorage.getItem('customAiModels') || '[]');
        const updatedCustomModels = customModels.map(model => 
          model.id === currentEditingModel.id ? updatedModel : model
        );
        saveCustomModels(updatedCustomModels);
      } else {
        // Modifier un modèle par défaut
        const modifiedDefaultModels = JSON.parse(localStorage.getItem('modifiedDefaultModels') || '[]');
        const existingModificationIndex = modifiedDefaultModels.findIndex(m => m.originalId === currentEditingModel.id);
        
        if (existingModificationIndex !== -1) {
          modifiedDefaultModels[existingModificationIndex] = {
            ...updatedModel,
            originalId: currentEditingModel.id
          };
        } else {
          modifiedDefaultModels.push({
            ...updatedModel,
            originalId: currentEditingModel.id
          });
        }
        
        saveModifiedDefaultModels(modifiedDefaultModels);
      }
      
      // Fermer le popup d'édition
      closeEditModel();
      
      // Mettre à jour l'affichage
      populateModelOptions();
      
      // Afficher un message de succès
      const statusDiv = document.getElementById('apiStatus');
      statusDiv.className = 'api-status success';
      statusDiv.style.display = 'block';
      statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Modèle modifié avec succès !';
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 3000);
    }

    function closeEditModel() {
      document.getElementById('editModelOverlay').style.display = 'none';
      currentEditingModel = null;
    }

    function deleteModel(modelId) {
      if (confirm('Êtes-vous sûr de vouloir supprimer ce modèle ?')) {
        const allModels = getAllModels();
        const model = allModels.find(m => m.id === modelId);
        
        if (!model) return;
        
        if (model.custom) {
          // Supprimer un modèle personnalisé
          const customModels = JSON.parse(localStorage.getItem('customAiModels') || '[]');
          const updatedCustomModels = customModels.filter(m => m.id !== modelId);
          saveCustomModels(updatedCustomModels);
        } else {
          // Supprimer la modification d'un modèle par défaut (retour à la version par défaut)
          const modifiedDefaultModels = JSON.parse(localStorage.getItem('modifiedDefaultModels') || '[]');
          const updatedModifiedModels = modifiedDefaultModels.filter(m => m.originalId !== modelId);
          saveModifiedDefaultModels(updatedModifiedModels);
        }
        
        // Recharger l'affichage
        populateModelOptions();
        
        // Vérifier si le modèle supprimé était sélectionné
        const currentModel = getCurrentModel();
        if (currentModel === modelId) {
          // Sélectionner le premier modèle disponible
          const aiModels = getAllModels();
          if (aiModels.length > 0) {
            selectModel(aiModels[0].id);
          }
        }
      }
    }

    function populateModelOptions() {
      const modelOptions = document.getElementById('modelOptions');
      const currentModel = getCurrentModel();
      const aiModels = getAllModels();
      
      modelOptions.innerHTML = '';
      
      aiModels.forEach(model => {
        const isSelected = model.id === currentModel;
        const optionElement = document.createElement('div');
        optionElement.className = `model-option ${isSelected ? 'selected' : ''}`;
        optionElement.onclick = () => selectModel(model.id);
        
        let badge = '';
        if (model.custom) {
          badge = '<span class="model-custom-badge">PERSO</span>';
        } else if (model.type === 'gratuit') {
          badge = '<span class="model-free-badge">GRATUIT</span>';
        } else if (model.type === 'preview') {
          badge = '<span class="model-preview-badge">PREVIEW</span>';
        } else {
          badge = '<span class="model-preview-badge">PAYANT</span>';
        }
        
        const actions = `
          <div class="model-actions">
            <button class="edit-model-btn-small" onclick="event.stopPropagation(); editModel('${model.id}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="delete-model-btn" onclick="event.stopPropagation(); deleteModel('${model.id}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        
        optionElement.innerHTML = `
          <input type="radio" class="model-radio" name="ai-model" ${isSelected ? 'checked' : ''}>
          <div class="model-info">
            <div class="model-name">${model.name} • ${model.provider} ${badge}</div>
            <div class="model-details">${model.description}</div>
          </div>
          ${actions}
        `;
        
        modelOptions.appendChild(optionElement);
      });
      
      updateCurrentModelDisplay();
    }

    function selectModel(modelId) {
      localStorage.setItem('selectedModel', modelId);
      populateModelOptions();
      updateCurrentModelDisplay();
    }

    function getCurrentModel() {
      return localStorage.getItem('selectedModel') || 'google/gemma-3-27b-it:free';
    }

    function updateCurrentModelDisplay() {
      const currentModel = getCurrentModel();
      const aiModels = getAllModels();
      const model = aiModels.find(m => m.id === currentModel);
      const displayElement = document.getElementById('currentModelDisplay');
      
      if (model) {
        let typeText = model.type;
        if (model.custom) {
          typeText = 'personnalisé';
        }
        displayElement.textContent = `${model.name} (${model.provider}) - ${typeText}`;
      }
    }

    // Fermer les popups en cliquant en dehors
    document.getElementById('settingsOverlay').addEventListener('click', function(e) {
      if (e.target === this) {
        closeSettings();
      }
    });

    document.getElementById('editModelOverlay').addEventListener('click', function(e) {
      if (e.target === this) {
        closeEditModel();
      }
    });

    // Fermer les popups avec la touche Échap
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeSettings();
        closeEditModel();
      }
    });

    // Fonction pour vérifier le statut de la clé API
    function checkApiKeyStatus() {
      if (!API_KEY || API_KEY.trim() === "" || !API_KEY.startsWith('sk-or-')) {
        console.log("Aucune clé API valide configurée");
        // Optionnel: Afficher un avertissement discret
        const statusDiv = document.getElementById("status");
        if (statusDiv) {
          statusDiv.className = "status error";
          statusDiv.style.display = "block";
          statusDiv.innerHTML = `
            <i class='fas fa-info-circle'></i> 
            Clé API non configurée. 
            <br><small>Configurez votre clé dans les paramètres pour utiliser l'analyse IA.</small>
          `;
          setTimeout(() => {
            statusDiv.style.display = "none";
          }, 5000);
        }
      }
    }

    // Fonction pour appliquer les corrections automatiques
    function applySpellingCorrections(text) {
      if (!text) return "";
      
      let correctedText = text;
      
      if (correctedText.length > 0) {
        correctedText = correctedText.charAt(0).toUpperCase() + correctedText.slice(1);
      }
      
      return correctedText;
    }

    // Fonction pour nettoyer les symboles *
    function cleanMarkdownSymbols(text) {
      if (!text) return "";
      
      let cleanedText = text
        .replace(/\*\*(.*?)\*\*/g, '$1')
        .replace(/\*(.*?)\*/g, '$1')
        .replace(/^\s*\*\s+/gm, '• ')
        .replace(/#{1,6}\s?/g, '')
        .replace(/\n\s*\*\s*/g, '\n• ')
        .replace(/`(.*?)`/g, '$1')
        .replace(/~~(.*?)~~/g, '$1')
        .replace(/\[(.*?)\]\(.*?\)/g, '$1');
      
      return cleanedText;
    }

    // Fonction pour détecter les sections principales
    function isMainSection(line, sections) {
      const mainSections = Object.keys(sections).map(section => section.toLowerCase());
      const lowerLine = line.toLowerCase();
      return mainSections.some(section => lowerLine.includes(section));
    }

    // Fonction pour détecter les sous-sections
    function isSubSection(line) {
      return line.includes(':') && !line.startsWith('•') && !line.startsWith('-') && line.length < 100;
    }

    // Fonction pour formater le texte d'export avec une présentation améliorée
    function formatTextForExport(text, job, location, details) {
      const now = new Date();
      const dateString = now.toLocaleDateString('fr-FR', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      let formattedText = '';
      
      // ================= EN-TÊTE =================
      formattedText += '='.repeat(60) + '\n';
      if (currentFunction === 'risk') {
        formattedText += 'ANALYSE DÉTAILLÉE DES RISQUES ' + sectorsConfig[currentSector].name.toUpperCase() + ' - DOCUMENT PROFESSIONNEL\n';
      } else {
        formattedText += 'PLAN DE PRÉVENTION DÉTAILLÉ ' + sectorsConfig[currentSector].name.toUpperCase() + ' - DOCUMENT PROFESSIONNEL\n';
      }
      formattedText += '='.repeat(60) + '\n\n';
      
      // ================= CONTENU DE L'ANALYSE =================
      const lines = text.split('\n');
      let currentSection = '';
      const sections = currentFunction === 'risk' ? sectorsConfig[currentSector].riskSections : sectorsConfig[currentSector].preventionSections;
      
      for (let line of lines) {
        const trimmedLine = line.trim();
        
        // Détection des sections principales
        if (isMainSection(trimmedLine, sections)) {
          if (currentSection) {
            formattedText += '\n';
          }
          
          currentSection = trimmedLine;
          formattedText += '\n' + '■'.repeat(50) + '\n';
          formattedText += `■ ${currentSection.toUpperCase()}\n`;
          formattedText += '■'.repeat(50) + '\n\n';
          
        } 
        // Détection des sous-sections
        else if (isSubSection(trimmedLine)) {
          formattedText += `▲ ${trimmedLine}\n`;
          formattedText += '─'.repeat(40) + '\n';
        }
        // Détection des éléments de liste
        else if (trimmedLine.startsWith('•') || trimmedLine.startsWith('-')) {
          const cleanItem = trimmedLine.replace(/^[•\-\s]*/, '');
          formattedText += `  ✓ ${cleanItem}\n`;
        }
        // Texte normal
        else if (trimmedLine) {
          if (trimmedLine.match(/^[A-Za-zÀ-ÿ\s]+:/)) {
            formattedText += `🔸 ${trimmedLine}\n`;
          } else {
            formattedText += `  ${trimmedLine}\n`;
          }
        } else {
          formattedText += '\n';
        }
      }
      
      // ================= PIED DE PAGE =================
      formattedText += '\n\n' + '='.repeat(60) + '\n';
      formattedText += 'MESURES DE SÉCURITÉ OBLIGATOIRES - ' + sectorsConfig[currentSector].name.toUpperCase() + '\n';
      formattedText += '='.repeat(60) + '\n\n';
      formattedText += '⚠️  Port des Équipements de Protection Individuelle (EPI) obligatoire\n';
      formattedText += '⚠️  Respect des procédures de sécurité en vigueur\n';
      formattedText += '⚠️  Signalisation appropriée du chantier\n';
      formattedText += '⚠️  Formation adaptée au personnel\n';
      formattedText += '⚠️  Surveillance continue des opérations\n\n';
      
      // ================= SECTION SPÉCIFIQUE AU PLAN DE PRÉVENTION =================
      if (currentFunction === 'prevention') {
        formattedText += '='.repeat(60) + '\n';
        formattedText += 'VALIDATION DU PLAN DE PRÉVENTION\n';
        formattedText += '='.repeat(60) + '\n\n';
        
        formattedText += '📅 DATE DE L\'INSPECTION COMMUNE PRÉALABLE :\n';
        formattedText += '   ____________________________________________________\n\n';
        
        formattedText += '👤 ENTREPRISE UTILISATRICE\n';
        formattedText += '   Nom de l\'entreprise : ______________________________\n';
        formattedText += '   Représentant : _____________________________________\n';
        formattedText += '   Fonction : _________________________________________\n';
        formattedText += '   Signature : \n';
        formattedText += '   \n';
        formattedText += '                     __________________________________\n';
        formattedText += '                              (Signature et cachet)\n\n';
        
        formattedText += '🏗️  ENTREPRISE EXTÉRIEURE\n';
        formattedText += '   Nom de l\'entreprise : ______________________________\n';
        formattedText += '   Représentant : _____________________________________\n';
        formattedText += '   Fonction : _________________________________________\n';
        formattedText += '   Signature : \n';
        formattedText += '   \n';
        formattedText += '                     __________________________________\n';
        formattedText += '                              (Signature et cachet)\n\n';
        
        formattedText += '📝 OBSERVATIONS ÉVENTUELLES :\n';
        formattedText += '   ____________________________________________________\n';
        formattedText += '   ____________________________________________________\n';
        formattedText += '   ____________________________________________________\n\n';
      }
      
      formattedText += '📋 DOCUMENT À CONSERVER DANS LE REGISTRE DE SÉCURITÉ\n\n';
      
      formattedText += '='.repeat(60) + '\n';
      formattedText += 'FIN DU DOCUMENT\n';
      formattedText += '='.repeat(60) + '\n';
      
      return formattedText;
    }

    // Formatage pour l'affichage HTML amélioré
    function formatForPreview(text) {
      if (!text) return "";
      
      let cleanText = cleanMarkdownSymbols(text);
      
      let result = '';
      let currentSection = '';
      let currentContent = '';
      const sections = currentFunction === 'risk' ? sectorsConfig[currentSector].riskSections : sectorsConfig[currentSector].preventionSections;

      const lines = cleanText.split('\n');
      
      for (let line of lines) {
        const trimmedLine = line.trim();
        
        const isSection = Object.keys(sections).some(section => 
          trimmedLine.toLowerCase().includes(section.toLowerCase()) || 
          /^\d+\.\s+.*/i.test(trimmedLine)
        );

        if (isSection) {
          if (currentSection && currentContent) {
            result += createSectionHTML(currentSection, currentContent, sections);
          }
          
          currentSection = trimmedLine;
          currentContent = '';
        } else if (trimmedLine) {
          currentContent += line + '\n';
        }
      }
      
      if (currentSection && currentContent) {
        result += createSectionHTML(currentSection, currentContent, sections);
      }
      
      return result;
    }

    // Créer le HTML pour une section
    function createSectionHTML(sectionTitle, content, sections) {
      let sectionConfig = sections[sectionTitle];
      if (!sectionConfig) {
        for (const [key, config] of Object.entries(sections)) {
          if (sectionTitle.toLowerCase().includes(key.toLowerCase())) {
            sectionConfig = config;
            break;
          }
        }
      }
      
      if (!sectionConfig) {
        sectionConfig = {
          icon: 'fas fa-exclamation-triangle',
          color: 'var(--accent)',
          subtitle: 'Informations importantes'
        };
      }
      
      let sectionHTML = `
        <div class="risk-section" style="--section-color: ${sectionConfig.color}">
          <div class="risk-header">
            <div class="risk-icon">
              <i class="${sectionConfig.icon}"></i>
            </div>
            <div>
              <div class="risk-title">${sectionTitle}</div>
              <div class="risk-subtitle">${sectionConfig.subtitle}</div>
            </div>
          </div>
          <div class="risk-content">
      `;
      
      const lines = content.split('\n');
      let currentSubRisk = '';
      let subRiskTitle = '';
      
      for (let line of lines) {
        const trimmedLine = line.trim();
        
        if (trimmedLine.startsWith('•') || trimmedLine.startsWith('-') || /^\w+:/i.test(trimmedLine)) {
          if (currentSubRisk) {
            sectionHTML += createSubRiskHTML(subRiskTitle, currentSubRisk, sectionConfig.color);
          }
          
          if (trimmedLine.includes(':')) {
            const parts = trimmedLine.split(':');
            subRiskTitle = parts[0].replace(/^[•\-\s]*/, '');
            currentSubRisk = parts.slice(1).join(':').trim();
          } else {
            subRiskTitle = '';
            currentSubRisk = trimmedLine.replace(/^[•\-\s]*/, '');
          }
        } else if (trimmedLine) {
          currentSubRisk += (currentSubRisk ? '\n' : '') + trimmedLine;
        }
      }
      
      if (currentSubRisk) {
        sectionHTML += createSubRiskHTML(subRiskTitle, currentSubRisk, sectionConfig.color);
      }
      
      sectionHTML += `
          </div>
        </div>
      `;
      
      return sectionHTML;
    }

    // Créer le HTML pour un sous-risque
    function createSubRiskHTML(title, content, color) {
      let subRiskHTML = `
        <div class="sub-risk" style="--sub-risk-color: ${color}">
      `;
      
      if (title) {
        subRiskHTML += `
          <div class="sub-risk-title">
            <i class="fas fa-chevron-right"></i>
            ${title}
          </div>
        `;
      }
      
      const items = content.split('\n').filter(item => item.trim());
      
      if (items.length > 0) {
        subRiskHTML += `<div class="sub-risk-items">`;
        items.forEach(item => {
          const cleanItem = item.replace(/^[•\-\s]*/, '').trim();
          if (cleanItem) {
            subRiskHTML += `<div class="sub-risk-item">${cleanItem}</div>`;
          }
        });
        subRiskHTML += `</div>`;
      }
      
      subRiskHTML += `</div>`;
      return subRiskHTML;
    }

    // Fonction pour exporter en fichier texte formaté
    function exportAsText() {
      if (!currentRawResponse) return;
      
      const job = document.getElementById("job").value.trim();
      const location = document.getElementById("location").value.trim();
      const details = document.getElementById("details").value.trim();
      
      const correctedJob = applySpellingCorrections(job);
      const correctedLocation = applySpellingCorrections(location);
      const correctedDetails = details ? applySpellingCorrections(details) : '';
      
      let cleanText = cleanMarkdownSymbols(currentRawResponse);
      
      // Formater le texte pour une meilleure présentation
      const formattedText = formatTextForExport(cleanText, correctedJob, correctedLocation, correctedDetails);
      
      const blob = new Blob([formattedText], { type: 'text/plain; charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const prefix = currentFunction === 'risk' ? 'analyse_risques' : 'plan_prevention';
      a.href = url;
      a.download = `${prefix}_${sectorsConfig[currentSector].name.replace(/\s+/g, '_')}_${correctedJob.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      const statusDiv = document.getElementById("status");
      statusDiv.className = "status success";
      statusDiv.style.display = "block";
      statusDiv.innerHTML = "<i class='fas fa-check-circle'></i> Fichier texte formaté téléchargé !";
      setTimeout(() => statusDiv.style.display = "none", 2500);
    }

    // FONCTION PRINCIPALE : Export en RTF (Rich Text Format)
    function exportAsRTF() {
      if (!currentRawResponse) return;
      
      const job = document.getElementById("job").value.trim();
      const location = document.getElementById("location").value.trim();
      const details = document.getElementById("details").value.trim();
      
      const correctedJob = applySpellingCorrections(job);
      const correctedLocation = applySpellingCorrections(location);
      const correctedDetails = details ? applySpellingCorrections(details) : '';
      
      let cleanText = cleanMarkdownSymbols(currentRawResponse);
      
      const rtfContent = generateRTFExport(cleanText, correctedJob, correctedLocation, correctedDetails);
      
      const blob = new Blob([rtfContent], { type: 'application/rtf; charset=windows-1252' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const prefix = currentFunction === 'risk' ? 'analyse_risques' : 'plan_prevention';
      a.href = url;
      a.download = `${prefix}_${sectorsConfig[currentSector].name.replace(/\s+/g, '_')}_${correctedJob.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().slice(0,10)}.rtf`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      const statusDiv = document.getElementById("status");
      statusDiv.className = "status success";
      statusDiv.style.display = "block";
      statusDiv.innerHTML = "<i class='fas fa-check-circle'></i> Document RTF formaté téléchargé !";
      setTimeout(() => statusDiv.style.display = "none", 2500);
    }

    // Fonction pour générer le contenu RTF formaté
    function generateRTFExport(text, job, location, details) {
      const now = new Date();
      const dateString = now.toLocaleDateString('fr-FR');
      
      const title = currentFunction === 'risk' ? 
        `ANALYSE DÉTAILLÉE DES RISQUES ${sectorsConfig[currentSector].name.toUpperCase()}` : 
        `PLAN DE PRÉVENTION DÉTAILLÉ ${sectorsConfig[currentSector].name.toUpperCase()}`;

      // En-tête RTF avec encodage Windows-1252 pour les caractères français
      let rtf = `{\\rtf1\\ansi\\ansicpg1252\\deff0 {\\fonttbl {\\f0 Arial;}}
\\margl1800\\margr1800\\margt1440\\margb1440
\\paperw11906\\paperh16838
\\f0\\fs24

\\qc\\b\\fs36 ${title}\\par
\\qc\\b\\fs28 DOCUMENT PROFESSIONNEL\\par
\\qc\\fs22 \\par
\\par

\\fs24\\b INFORMATIONS DU CHANTIER\\par
\\fs20\\b0 Métier/Tâche : \\b ${escapeRTF(job)}\\b0\\par
Lieu : \\b ${escapeRTF(location)}\\b0\\par
Contexte : \\b ${escapeRTF(details || 'Non renseigné')}\\b0\\par
Secteur : \\b ${escapeRTF(sectorsConfig[currentSector].name)}\\b0\\par
Date : \\b ${escapeRTF(dateString)}\\b0\\par
\\par

\\b\\fs28 ANALYSE DÉTAILLÉE\\par
\\fs24\\b0\\par
`;

      // Traitement du contenu
      const lines = text.split('\n');
      let inList = false;
      
      for (let line of lines) {
        const trimmedLine = line.trim();
        
        if (!trimmedLine) {
          rtf += `\\par`;
          continue;
        }
        
        if (isMainSection(trimmedLine, currentFunction === 'risk' ? sectorsConfig[currentSector].riskSections : sectorsConfig[currentSector].preventionSections)) {
          if (inList) {
            rtf += `\\pard\\par`;
            inList = false;
          }
          rtf += `\\b\\fs26 ${escapeRTF(trimmedLine.toUpperCase())}\\par\\b0\\fs20\\par`;
        } 
        else if (trimmedLine.includes(':') && trimmedLine.length < 100) {
          if (inList) {
            rtf += `\\pard\\par`;
            inList = false;
          }
          const parts = trimmedLine.split(':');
          const title = parts[0].trim();
          const content = parts.slice(1).join(':').trim();
          
          rtf += `\\b ${escapeRTF(title)} :\\b0 ${escapeRTF(content)}\\par\\par`;
        }
        else if (trimmedLine.startsWith('•') || trimmedLine.startsWith('-')) {
          if (!inList) {
            rtf += `\\pard\\fi-360\\li720 `;
            inList = true;
          }
          const cleanItem = trimmedLine.replace(/^[•\-\s]*/, '');
          rtf += `\\bullet  ${escapeRTF(cleanItem)}\\par `;
        }
        else {
          if (inList) {
            rtf += `\\pard\\par`;
            inList = false;
          }
          rtf += `${escapeRTF(trimmedLine)}\\par\\par`;
        }
      }

      if (inList) {
        rtf += `\\pard\\par`;
      }

      // Mesures de sécurité
      rtf += `\\par
\\b\\fs26 MESURES DE SÉCURITÉ OBLIGATOIRES\\par
\\b0\\fs20
\\pard\\fi-360\\li720 
\\bullet  Port des Équipements de Protection Individuelle (EPI) obligatoire\\par 
\\bullet  Respect des procédures de sécurité en vigueur\\par 
\\bullet  Signalisation appropriée du chantier\\par 
\\bullet  Formation adaptée au personnel\\par 
\\bullet  Surveillance continue des opérations\\par
\\pard\\par
`;

      // Section signature pour les plans de prévention
      if (currentFunction === 'prevention') {
        rtf += `\\b\\fs26 VALIDATION DU PLAN DE PRÉVENTION\\par
\\b0\\fs20
\\b DATE DE L'INSPECTION COMMUNE PRÉALABLE :\\b0\\par
____________________________________________________\\par
\\par

{\\fs18\\b ENTREPRISE UTILISATRICE\\par}
{\\fs16\\b0 Nom de l'entreprise :} ______________________________\\par
{\\fs16\\b0 Représentant :} _____________________________________\\par
{\\fs16\\b0 Fonction :} _________________________________________\\par
\\par
{\\fs16 Signature :}\\par
\\par
\\tqr\\tx4000 __________________________________\\par
\\qc\\fs12 (Signature et cachet)\\par
\\ql\\par
\\par

{\\fs18\\b ENTREPRISE EXTÉRIEURE\\par}
{\\fs16\\b0 Nom de l'entreprise :} ______________________________\\par
{\\fs16\\b0 Représentant :} _____________________________________\\par
{\\fs16\\b0 Fonction :} _________________________________________\\par
\\par
{\\fs16 Signature :}\\par
\\par
\\tqr\\tx4000 __________________________________\\par
\\qc\\fs12 (Signature et cachet)\\par
\\ql\\par
\\par

{\\fs18\\b OBSERVATIONS ÉVENTUELLES :\\b0\\par}
____________________________________________________\\par
____________________________________________________\\par
____________________________________________________\\par
\\par
`;
      }

      // Pied de page
      rtf += `\\par
\\fs16 Document généré automatiquement - À conserver dans le registre de sécurité\\par
Date de génération : ${escapeRTF(new Date().toLocaleString('fr-FR'))}\\par
}`;

      return rtf;
    }

    // Fonction utilitaire pour échapper les caractères spéciaux RTF
    function escapeRTF(text) {
      if (!text) return "";
      return text
        .replace(/\\/g, '\\\\')
        .replace(/{/g, '\\{')
        .replace(/}/g, '\\}')
        .replace(/\n/g, '\\par ')
        .replace(/\t/g, '\\tab ')
        .replace(/\f/g, '\\page ')
        .replace(/[\u00A0-\u00FF]/g, function(char) {
          return '\\u' + char.charCodeAt(0) + '?';
        });
    }

    async function analyzeWithAI() {
      // VÉRIFICATION DE LA CLÉ API AVANT TOUT
      if (!API_KEY || API_KEY.trim() === "") {
        const statusDiv = document.getElementById("status");
        statusDiv.className = "status error";
        statusDiv.style.display = "block";
        statusDiv.innerHTML = `
          <i class='fas fa-exclamation-triangle'></i> 
          Aucune clé API configurée. 
          <br><small>Veuillez configurer votre clé API OpenRouter dans les paramètres.</small>
        `;
        return;
      }

      // Vérification supplémentaire du format de la clé API
      if (!API_KEY.startsWith('sk-or-')) {
        const statusDiv = document.getElementById("status");
        statusDiv.className = "status error";
        statusDiv.style.display = "block";
        statusDiv.innerHTML = `
          <i class='fas fa-exclamation-triangle'></i> 
          Clé API invalide. 
          <br><small>La clé doit commencer par 'sk-or-'. Vérifiez vos paramètres.</small>
        `;
        return;
      }

      const model = getCurrentModel();
      const job = document.getElementById("job").value.trim();
      const location = document.getElementById("location").value.trim();
      const details = document.getElementById("details").value.trim();
      const btn = document.querySelector(".btn-analyze");
      const statusDiv = document.getElementById("status");
      const previewDiv = document.getElementById("preview");
      const previewContent = document.getElementById("previewContent");
      const previewTitle = document.getElementById("previewTitle");
      const previewSubtitle = document.getElementById("previewSubtitle");
      const exportOptions = document.getElementById("exportOptions");

      if (!job || !location) {
        statusDiv.className = "status error";
        statusDiv.style.display = "block";
        statusDiv.innerHTML = "<i class='fas fa-exclamation-triangle'></i> Veuillez remplir 'Métier/tâche' et 'Lieu'.";
        return;
      }

      btn.disabled = true;
      if (currentFunction === 'risk') {
        btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Analyse détaillée en cours…";
        previewTitle.textContent = `Analyse Détaillée des Risques - ${sectorsConfig[currentSector].name}`;
        previewSubtitle.textContent = "Résultat de l'analyse exhaustive généré automatiquement";
      } else {
        btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Génération détaillée en cours…";
        previewTitle.textContent = `Plan de Prévention Détaillé - ${sectorsConfig[currentSector].name}`;
        previewSubtitle.textContent = "Plan de prévention exhaustif généré automatiquement";
      }
      statusDiv.style.display = "none";
      previewDiv.style.display = "none";
      exportOptions.style.display = "none";

      let prompt = '';
      const sectorConfig = sectorsConfig[currentSector];
      
      if (currentFunction === 'risk') {
        // PROMPT pour l'analyse des risques adapté au secteur - VERSION DÉTAILLÉE
        prompt = `En tant qu'expert senior en prévention des risques professionnels spécialisé dans le secteur ${sectorConfig.name} en France, vous maîtrisez parfaitement les réglementations en vigueur, les normes de sécurité, ainsi que les procédures à suivre pour minimizer les accidents de travail.

Réalisez une analyse exhaustive et extrêmement détaillée des dangers liés à :

- Tâche/métier : ${job}
- Lieu : ${location}
${details ? `- Contexte spécifique : ${details}` : ''}

Structurez votre réponse en 8 parties détaillées adaptées au secteur ${sectorConfig.name} :
0. Description exhaustive des travaux ou du travail à effectuer : Fournissez un résumé complet et détaillé des éléments renseignés (qui, quoi, où, quand, comment, pourquoi)
${Object.keys(sectorConfig.riskSections).slice(1).map((section, index) => `${index + 1}. ${section} : ${sectorConfig.riskSections[section].subtitle}`).join('\n')}

EXIGENCES SPÉCIFIQUES :
• Fournissez une analyse extrêmement détaillée et exhaustive
• Mentionnez les réglementations spécifiques applicables
• Incluez des exemples concrets et des cas pratiques
• Développez chaque point avec précision et exhaustivité
• Structurez avec des sous-sections détaillées
• Utilisez un langage technique professionnel adapté au secteur
• Évitez d'utiliser des symboles de formatage markdown comme *, **, #, etc.

Tenez compte des spécificités techniques, réglementaires et organisationnelles du secteur ${sectorConfig.name}.`;
      } else {
        // PROMPT pour le plan de prévention adapté au secteur - VERSION DÉTAILLÉE
        prompt = `En tant qu'expert senior en prévention des risques professionnels spécialisé dans le secteur ${sectorConfig.name} en France, vous maîtrisez parfaitement les réglementations en vigueur, les normes de sécurité, ainsi que les procédures à suivre pour élaborer des plans de prévention complets.

Élaborez un plan de prévention exhaustif et extrêmement détaillée pour :

- Tâche/métier : ${job}
- Lieu : ${location}
${details ? `- Contexte spécifique : ${details}` : ''}

Structurez votre réponse en 8 parties détaillées adaptées au secteur ${sectorConfig.name} :
0. Description exhaustive des travaux ou du travail à effectuer : Fournissez un résumé complet et détaillé des éléments renseignés (qui, quoi, où, quand, comment, pourquoi)
${Object.keys(sectorConfig.preventionSections).slice(1).map((section, index) => `${index + 1}. ${section} : ${sectorConfig.preventionSections[section].subtitle}`).join('\n')}

EXIGENCES SPÉCIFIQUES :
• Fournissez un plan extrêmement détaillé et exhaustif
• Mentionnez les réglementations spécifiques applicables
• Incluez des procédures opérationnelles détaillées
• Développez chaque point avec précision et exhaustivité
• Structurez avec des sous-sections détaillées
• Utilisez un langage technique professionnel adapté au secteur
• Évitez d'utiliser des symboles de formatage markdown comme *, **, #, etc.

Tenez compte des spécificités techniques, réglementaires et organisationnelles du secteur ${sectorConfig.name}.`;
      }

      try {
        const response = await fetch(API_URL, {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${API_KEY}`,
            "Content-Type": "application/json",
            "HTTP-Referer": window.location.href,
            "X-Title": "Copie du résultat"
          },
          body: JSON.stringify({
            model: model,
            messages: [{ role: "user", content: prompt }],
            temperature: 0.3,
            max_tokens: 4000
          })
        });

        const data = await response.json();
        if (!response.ok || data.error) throw new Error(data.error?.message || "Erreur API");

        currentRawResponse = data.choices?.[0]?.message?.content?.trim() || "Aucune réponse reçue.";
        
        const cleanedResponse = cleanMarkdownSymbols(currentRawResponse);
        previewContent.innerHTML = formatForPreview(cleanedResponse);
        previewDiv.style.display = "block";
        exportOptions.style.display = "flex";

        statusDiv.className = "status success";
        statusDiv.style.display = "block";
        const successMessage = currentFunction === 'risk' ? 
          "Analyse détaillée terminée. Vous pouvez exporter le résultat." : 
          "Plan de prévention détaillé généré. Vous pouvez exporter le résultat.";
        statusDiv.innerHTML = `<i class='fas fa-check-circle'></i> ${successMessage}`;
      } catch (error) {
        console.error("Erreur :", error);
        statusDiv.className = "status error";
        statusDiv.style.display = "block";
        statusDiv.innerHTML = `<i class='fas fa-exclamation-circle'></i> ${error.message}`;
      } finally {
        btn.disabled = false;
        if (currentFunction === 'risk') {
          btn.innerHTML = "<i class='fas fa-search'></i> Analyser les risques";
        } else {
          btn.innerHTML = "<i class='fas fa-shield-alt'></i> Générer le plan de prévention";
        }
      }
    }

    // Initialiser les éléments flottants au chargement
    window.addEventListener('DOMContentLoaded', () => {
      createFloatingElements();
      updateCurrentModelDisplay();
      loadApiKey();
      checkApiKeyStatus();
      updateReglementationInfo();
      
      // Initialiser le compteur de caractères pour l'API Key
      const apiKeyInput = document.getElementById('apiKeyInput');
      if (apiKeyInput) {
        apiKeyInput.addEventListener('input', updateApiKeyCounter);
        updateApiKeyCounter();
      }
    });
  </script>
</body>
</html>